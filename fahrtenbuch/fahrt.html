<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fahrt – TaskSuite</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .container { max-width: 800px; margin: 0 auto; padding: 1rem; }
    .card { background: white; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
    .field { margin-bottom: 1rem; }
    .field label { font-weight: bold; color: #495057; }
    .field span { display: block; margin-top: 0.2rem; }
    .status-badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 4px;
      font-weight: bold;
      font-size: 0.85rem;
    }
    .status.pending { background: #fff3cd; color: #856404; }
    .status.completed { background: #d4edda; color: #155724; }
    .status.deleted { background: #f8d7da; color: #721c24; }
    img.preview { max-width: 100%; border-radius: 4px; margin-top: 0.5rem; }
    .btn {
      display: inline-block;
      padding: 0.6rem 1.2rem;
      background: #0d6efd;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      margin-top: 1rem;
    }
    .btn:hover { background: #0b5ed7; }
    .back-link { display: inline-block; margin: 1rem 0; }
  </style>
</head>
<body>
  <div class="container">
    <a href="/fahrtenbuch" class="back-link">← Zurück zur Fahrtenliste</a>
    <h1>Fahrt Details</h1>

    <div id="rideDetails">
      <p>Lade Fahrt...</p>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient(
      'https://kphmtjtekbehvbuqmndz.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwaG10anRla2JlaHZidXFtbmR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MDc3NDEsImV4cCI6MjA3ODk4Mzc0MX0.P6dpB_jSEXE2jdF19tmv4pE-g3_EDFdTX_d74PUTz9U'
    );

    function getUrlParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    function formatDateTime(isoString) {
      if (!isoString) return '–';
      const d = new Date(isoString);
      return d.toLocaleString('de-DE');
    }

    function renderRide(ride) {
      const statusClass = ride.status || 'pending';
      const statusLabels = {
        pending: 'Warte auf Ankunft',
        completed: 'Abgeschlossen',
        deleted: 'Gelöscht'
      };
      const statusText = statusLabels[ride.status] || ride.status;

      let html = `
        <div class="card">
          <div class="field">
            <label>Status</label>
            <span><span class="status-badge status ${statusClass}">${statusText}</span></span>
          </div>
          <div class="field">
            <label>Fahrer</label>
            <span>${ride.full_name}</span>
          </div>
          <div class="field">
            <label>Abfahrt</label>
            <span>${formatDateTime(ride.departure_at)}</span>
          </div>
          <div class="field">
            <label>Startort</label>
            <span>${ride.start_location}</span>
          </div>
          <div class="field">
            <label>Zielort</label>
            <span>${ride.destination}</span>
          </div>
          <div class="field">
            <label>Kilometerstand Start</label>
            <span>${ride.km_start || '–'} km</span>
          </div>
      `;

      // Foto Start
      if (ride.photo_start_url) {
        const photoUrl = supabase.storage.from('ride-photos').getPublicUrl(ride.photo_start_url).data.publicUrl;
        html += `
          <div class="field">
            <label>Foto km-Stand (Start)</label>
            <img src="${photoUrl}" class="preview" alt="km-Stand Start">
          </div>
        `;
      }

      // Wenn abgeschlossen
      if (ride.status === 'completed') {
        html += `
          <div class="field">
            <label>Ankunft</label>
            <span>${formatDateTime(ride.arrival_at)}</span>
          </div>
          <div class="field">
            <label>Kilometerstand Ende</label>
            <span>${ride.km_end || '–'} km</span>
          </div>
        `;
        if (ride.photo_end_url) {
          const photoEndUrl = supabase.storage.from('ride-photos').getPublicUrl(ride.photo_end_url).data.publicUrl;
          html += `
            <div class="field">
              <label>Foto km-Stand (Ende)</label>
              <img src="${photoEndUrl}" class="preview" alt="km-Stand Ende">
            </div>
          `;
        }
        if (ride.signature_url) {
          const sigUrl = supabase.storage.from('signatures').getPublicUrl(ride.signature_url).data.publicUrl;
          html += `
            <div class="field">
              <label>Unterschrift</label>
              <img src="${sigUrl}" class="preview" alt="Unterschrift">
            </div>
          `;
        }
      }

      // Wenn gelöscht
      if (ride.status === 'deleted') {
        html += `
          <div class="field">
            <label>Löschgrund</label>
            <span>${ride.deleted_reason || 'Kein Grund angegeben'}</span>
          </div>
        `;
        if (ride.deleted_signature_url) {
          const delSigUrl = supabase.storage.from('signatures').getPublicUrl(ride.deleted_signature_url).data.publicUrl;
          html += `
            <div class="field">
              <label>Unterschrift (Löschung)</label>
              <img src="${delSigUrl}" class="preview" alt="Lösch-Unterschrift">
            </div>
          `;
        }
      }

      html += '</div>';

      // Zeige Button nur bei "pending"
      if (ride.status === 'pending') {
        html += `
          <a href="/fahrtenbuch/ankunft.html?id=${ride.id}" class="btn">→ Ankunft erfassen</a>
        `;
      }

      document.getElementById('rideDetails').innerHTML = html;
    }

    async function loadRide() {
      const rideId = getUrlParam('id');
      if (!rideId) {
        document.getElementById('rideDetails').innerHTML = '<p>❌ Keine Fahrt-ID angegeben.</p>';
        return;
      }

      const {  ride, error } = await supabase
        .from('rides')
        .select('*')
        .eq('id', rideId)
        .single();

      if (error) {
        document.getElementById('rideDetails').innerHTML = `<p>❌ Fehler: ${error.message}</p>`;
        return;
      }

      renderRide(ride);
    }

    loadRide();
  </script>
</body>
</html>

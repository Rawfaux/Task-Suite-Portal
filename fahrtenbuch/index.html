<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fahrtenbuch – TaskSuite</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .header-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    th, td {
      padding: 0.8rem 0.6rem;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
    }
    tr:hover {
      background: #f5f9ff;
    }
    .status {
      padding: 0.2rem 0.6rem;
      border-radius: 4px;
      font-size: 0.85rem;
      font-weight: bold;
    }
    .status.pending { background: #fff3cd; color: #856404; }
    .status.completed { background: #d4edda; color: #155724; }
    .status.deleted { background: #f8d7da; color: #721c24; }
    .no-rides {
      text-align: center;
      padding: 2rem;
      color: #6c757d;
    }
    .back-link { display: inline-block; margin: 1rem 0; }
  </style>
</head>
<body>
  <a href="/" class="back-link">← Zurück zum Dashboard</a>

  <div class="header-actions">
    <h1>Fahrtenbuch</h1>
    <a href="/fahrtenbuch/neue-fahrt.html" class="tile" style="width:auto; padding:0.6rem 1rem; text-align:center; text-decoration:none;">
      + Neue Fahrt
    </a>
  </div>

  <div id="ridesList">
    <p>Lade Fahrten...</p>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient(
      'https://kphmtjtekbehvbuqmndz.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwaG10anRla2JlaHZidXFtbmR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MDc3NDEsImV4cCI6MjA3ODk4Mzc0MX0.P6dpB_jSEXE2jdF19tmv4pE-g3_EDFdTX_d74PUTz9U'
    );

    function formatDateTime(isoString) {
      if (!isoString) return '–';
      const d = new Date(isoString);
      return d.toLocaleString('de-DE', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatStatus(status) {
      const labels = {
        pending: 'Warte auf Ankunft',
        completed: 'Abgeschlossen',
        deleted: 'Gelöscht'
      };
      return labels[status] || status;
    }

    async function loadRides() {
      const {  { session } } = await supabase.auth.getSession();
      if (!session) {
        document.getElementById('ridesList').innerHTML = 
          '<p>❌ Nicht eingeloggt. <a href="/login">Login</a></p>';
        return;
      }

      const {  rides, error } = await supabase
        .from('rides')
        .select('*')
        .order('departure_at', { ascending: false });

      if (error) {
        document.getElementById('ridesList').innerHTML = 
          `<p>❌ Fehler beim Laden: ${error.message}</p>`;
        return;
      }

      if (rides.length === 0) {
        document.getElementById('ridesList').innerHTML = 
          '<p class="no-rides">Noch keine Fahrten erfasst.</p>';
        return;
      }

html += `
  <tr onclick="window.location='/fahrtenbuch/fahrt.html?id=${ride.id}'" style="cursor:pointer;">
    <td>${formatDateTime(ride.departure_at)}</td>
    <td>${ride.full_name}</td>
    <td>${ride.start_location} → ${ride.destination}</td>
    <td>${ride.km_start || '–'}</td>
    <td><span class="status ${ride.status}">${formatStatus(ride.status)}</span></td>
  </tr>
`;

      rides.forEach(ride => {
        html += `
          <tr>
            <td>${formatDateTime(ride.departure_at)}</td>
            <td>${ride.full_name}</td>
            <td>${ride.start_location} → ${ride.destination}</td>
            <td>${ride.km_start || '–'}</td>
            <td><span class="status ${ride.status}">${formatStatus(ride.status)}</span></td>
          </tr>
        `;
      });

      html += `
          </tbody>
        </table>
      `;

      document.getElementById('ridesList').innerHTML = html;
    }

    loadRides();
  </script>
</body>
</html>
